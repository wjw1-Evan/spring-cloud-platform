server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  # API proxy to backend gateway inside the docker network
  location /auth/ {
    # Handle CORS preflight directly to avoid failing when upstream is temporarily unavailable
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    proxy_pass http://gateway:8080/auth/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    # Add CORS headers on proxied responses
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
  }

  location /users/ {
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    proxy_pass http://gateway:8080/users/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
  }

  location /console/ {
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    proxy_pass http://gateway:8080/console/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
  }

  # Proxy API prefix to gateway (useful when front-end uses /api/* paths)
  location /api/ {
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    proxy_pass http://gateway:8080/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
  }

  # Serve SPA
  # Debug endpoint: echo incoming Authorization header in response header X-Echo-Authorization
  location = /_debug/echo {
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
      add_header 'Access-Control-Max-Age' 1728000;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }
    add_header 'Access-Control-Allow-Origin' '*';
    add_header 'X-Echo-Authorization' "$http_authorization";
    return 200;
  }
  location / {
    try_files $uri $uri/ /index.html;
  }
}
